<div class="ficha-militar-container">
  <form [formGroup]="fichaForm" class="ficha-militar-form"
   [ngClass]="'state-' + formState" (ngSubmit)="onSubmit()">

    <!-- Header Section -->
    <div class="form-header">
      <h2 class="form-title">{{ displayTitle }}</h2>
      <!-- State indicator -->
      <span class="state-indicator" [ngClass]="'state-' + formState">
        {{ getFormStateLabel() }}
      </span>
    </div>

    <!-- Action buttons section -->
    <div class="action-buttons">
      <button
        mat-raised-button type="button"
        class="action-button new-button"
        (click)="onNew()"
        [disabled]="formState === 'insert'"
        matTooltip="Novo registro">
        <mat-icon>add</mat-icon>
        Novo
      </button>

      <button
        mat-raised-button type="button"
        class="action-button edit-button"
        (click)="onEdit()"
        [disabled]="formState === 'update' || !isDocumentLoaded"
        matTooltip="Editar registro atual">
        <mat-icon>edit</mat-icon>
        Editar
      </button>

      <button
        mat-raised-button type="button"
        class="action-button cancel-button"
        (click)="onCancel()"
        [disabled]="formState === 'cancel'"
        matTooltip="Cancelar alterações">
        <mat-icon>cancel</mat-icon>
        Cancelar
      </button>

      <button
        mat-raised-button
        type="submit"
        color="primary"
        class="action-button save-button"
        [disabled]="!canPerformActions() || fichaForm.invalid"
        matTooltip="Salvar alterações"  >
        <mat-icon>save</mat-icon>
        Salvar
      </button>
    </div>

    <!-- Main Form Content -->
    <div class="form-content">

      <!-- Campos Principais (sempre visíveis) -->
      <div class="main-fields-section">
        <div class="section-header">
          <h3 class="section-title">
            <mat-icon>badge</mat-icon>
            Dados Principais
          </h3>
        </div>

        <div class="main-fields-grid">

          <!-- NIM - Campo col-sm-3 -->
          <div class="form-group field-nim">
            <mat-form-field appearance="outline">
              <mat-label>NIM</mat-label>
              <input matInput formControlName="nim" type="number" [disabled]="!canPerformActions()">
              <button mat-icon-button matSuffix
                      class="search-button document-search"
                      (click)="onMilitarSearchClick('nim,nome,milstamp')"
                      type="button"
                      [disabled]="formState !== 'cancel'">
                <mat-icon>search</mat-icon>
              </button>
             </mat-form-field>
          </div>

          <!-- Nome - Campo com maior espaço disponível -->
          <div class="form-group field-nome">
            <mat-form-field appearance="outline">
              <mat-label>Nome Completo</mat-label>
              <input matInput formControlName="nome" [disabled]="!canPerformActions()">
              <button mat-icon-button matSuffix
                      class="search-button document-search"
                      (click)="onMilitarSearchClick('nome,nim,milstamp')"
                      type="button"
                      [disabled]="formState !== 'cancel'">
                <mat-icon>search</mat-icon>
              </button>
            </mat-form-field>
          </div>

          <!-- Situação - Campo col-sm-3 -->
          <div class="form-group field-situacao">
            <mat-form-field appearance="outline">
              <mat-label>Situação Atual</mat-label>
              <input matInput
                     formControlName="situacaoAtual"
                     [disabled]="!canPerformActions()"
                     [matAutocomplete]="autoSituacao"
                     placeholder="Digite para procurar...">
              <mat-autocomplete #autoSituacao="matAutocomplete">
                <mat-option *ngFor="let situacao of filteredSituacao | async" [value]="situacao">
                  {{situacao}}
                </mat-option>
              </mat-autocomplete>
              <mat-icon matSuffix>assignment_ind</mat-icon>
              <mat-hint>Situação militar atual</mat-hint>
            </mat-form-field>
          </div>
        </div>
      </div>

      <mat-divider></mat-divider>

      <!-- Tab Group -->
      <mat-tab-group class="custom-tab-group" dynamicHeight>

        <!-- Tab 1: Dados Pessoais -->
        <mat-tab label="Dados Pessoais">
          <div class="tab-content">
            <div class="section-header">
              <h3 class="section-title">
                <mat-icon>person</mat-icon>
                Informações Pessoais
              </h3>
            </div>

            <div class="row">
              <!-- Coluna dos campos (col-sm-10) -->
              <div class="col-sm-10">
                <div class="form-grid">
                  <!-- Primeira linha: Data de Nascimento, Estado Civil, Sexo e Grupo Sanguíneo -->
                  <div class="form-group">
                    <mat-form-field appearance="outline">
                      <mat-label>Data de Nascimento</mat-label>
                      <input matInput [matDatepicker]="nascData" formControlName="nascData" [disabled]="!canPerformActions()">
                      <mat-datepicker-toggle matSuffix [for]="nascData" [disabled]="!canPerformActions()"></mat-datepicker-toggle>
                      <mat-datepicker #nascData [disabled]="!canPerformActions()"></mat-datepicker>
                    </mat-form-field>
                  </div>

                  <div class="form-group">
                    <mat-form-field appearance="outline">
                      <mat-label>Estado Civil</mat-label>
                      <input matInput
                             formControlName="estCivil"
                             [disabled]="!canPerformActions()"
                             [matAutocomplete]="autoEstCivil"
                             placeholder="Digite para procurar...">
                      <mat-autocomplete #autoEstCivil="matAutocomplete"
                                        [displayWith]="displayFunction"
                                        (optionSelected)="onOptionSelected('estCivil', $event)">
                        <mat-option *ngFor="let estado of filteredEstCivil | async" [value]="estado">
                          {{estado}}
                        </mat-option>
                      </mat-autocomplete>
                      <button mat-icon-button matSuffix
                              type="button"
                              (click)="clearSelectionWithReset('estCivil', autoEstCivil)"
                              [disabled]="!canPerformActions() || !fichaForm.get('estCivil')?.value"
                              matTooltip="Limpar seleção">
                        <mat-icon>clear</mat-icon>
                      </button>
                    </mat-form-field>
                  </div>

                  <div class="form-group">
                    <mat-form-field appearance="outline">
                      <mat-label>Sexo</mat-label>
                      <input matInput
                             formControlName="sexo"
                             [disabled]="!canPerformActions()"
                             [matAutocomplete]="autoSexo"
                             placeholder="Digite para procurar...">
                      <mat-autocomplete #autoSexo="matAutocomplete"
                                        [displayWith]="displayFunction"
                                        (optionSelected)="onOptionSelected('sexo', $event)">
                        <mat-option *ngFor="let sexo of filteredSexo | async" [value]="sexo">
                          {{sexo}}
                        </mat-option>
                      </mat-autocomplete>
                      <button mat-icon-button matSuffix
                              type="button"
                              (click)="clearSelectionWithReset('sexo', autoSexo)"
                              [disabled]="!canPerformActions() || !fichaForm.get('sexo')?.value"
                              matTooltip="Limpar seleção">
                        <mat-icon>clear</mat-icon>
                      </button>
                    </mat-form-field>
                  </div>

                  <div class="form-group">
                    <mat-form-field appearance="outline">
                      <mat-label>Grupo Sanguíneo</mat-label>
                      <input matInput
                             formControlName="grupSangue"
                             [disabled]="!canPerformActions()"
                             [matAutocomplete]="autoGrupSangue"
                             placeholder="Digite para procurar...">
                      <mat-autocomplete #autoGrupSangue="matAutocomplete"
                                        [displayWith]="displayFunction"
                                        (optionSelected)="onOptionSelected('grupSangue', $event)">
                        <mat-option *ngFor="let grupo of filteredGrupSangue | async" [value]="grupo">
                          {{grupo}}
                        </mat-option>
                      </mat-autocomplete>
                      <button mat-icon-button matSuffix
                              type="button"
                              (click)="clearSelectionWithReset('grupSangue', autoGrupSangue)"
                              [disabled]="!canPerformActions() || !fichaForm.get('grupSangue')?.value"
                              matTooltip="Limpar seleção">
                        <mat-icon>clear</mat-icon>
                      </button>
                    </mat-form-field>
                  </div>

                  <!-- Segunda linha: Nacionalidade e Cônjuge (ocupando toda a linha) -->
                  <div class="form-group form-group-half">
                    <mat-form-field appearance="outline">
                      <mat-label>Nacionalidade</mat-label>
                      <input matInput formControlName="nacional" [disabled]="!canPerformActions()">
                      <button mat-icon-button matSuffix
                              class="search-button document-search"
                              (click)="searchNacionalidade()"
                              type="button"
                              [disabled]="!canPerformActions()"
                              matTooltip="Procurar Nacionalidade">
                        <mat-icon>menu_vert</mat-icon>
                      </button>
                    </mat-form-field>
                  </div>

                  <div class="form-group form-group-half">
                    <mat-form-field appearance="outline">
                      <mat-label>Cônjuge</mat-label>
                      <input matInput formControlName="conjuge" [disabled]="!canPerformActions()">
                    </mat-form-field>
                  </div>

                  <!-- Terceira linha: Pai e Mãe (ocupando toda a linha) -->
                  <div class="form-group form-group-half">
                    <mat-form-field appearance="outline">
                      <mat-label>Pai</mat-label>
                      <input matInput formControlName="pai" [disabled]="!canPerformActions()">
                    </mat-form-field>
                  </div>

                  <div class="form-group form-group-half">
                    <mat-form-field appearance="outline">
                      <mat-label>Mãe</mat-label>
                      <input matInput formControlName="mae" [disabled]="!canPerformActions()">
                    </mat-form-field>
                  </div>

                  <!-- Quarta linha: Data de Casamento, Número de Filhos, Habilitações Literárias e Ramo -->
                  <div class="form-group">
                    <mat-form-field appearance="outline">
                      <mat-label>Data de Casamento</mat-label>
                      <input matInput [matDatepicker]="dataCasamento" formControlName="dataCasamento" [disabled]="!canPerformActions()">
                      <mat-datepicker-toggle matSuffix [for]="dataCasamento" [disabled]="!canPerformActions()"></mat-datepicker-toggle>
                      <mat-datepicker #dataCasamento [disabled]="!canPerformActions()"></mat-datepicker>
                    </mat-form-field>
                  </div>

                  <div class="form-group">
                    <mat-form-field appearance="outline">
                      <mat-label>Número de Filhos</mat-label>
                      <input matInput formControlName="numFilhos" type="number" [disabled]="!canPerformActions()">
                    </mat-form-field>
                  </div>

                  <div class="form-group">
                    <mat-form-field appearance="outline">
                      <mat-label>Habilitações Literárias</mat-label>
                      <input matInput
                             formControlName="habiLite"
                             [disabled]="!canPerformActions()"
                             [matAutocomplete]="autoHabilitacoes"
                             placeholder="Digite para procurar...">
                      <mat-autocomplete #autoHabilitacoes="matAutocomplete"
                                        [displayWith]="displayFunction"
                                        (optionSelected)="onOptionSelected('habiLite', $event)">
                        <mat-option *ngFor="let habilitacao of filteredHabilitacoes | async" [value]="habilitacao">
                          {{habilitacao}}
                        </mat-option>
                      </mat-autocomplete>
                      <button mat-icon-button matSuffix
                              type="button"
                              (click)="clearSelectionWithReset('habiLite', autoHabilitacoes)"
                              [disabled]="!canPerformActions() || !fichaForm.get('habiLite')?.value"
                              matTooltip="Limpar seleção">
                        <mat-icon>clear</mat-icon>
                      </button>
                    </mat-form-field>
                  </div>

                  <div class="form-group">
                    <mat-form-field appearance="outline">
                      <mat-label>Ramo</mat-label>
                      <input matInput formControlName="ramo" [disabled]="!canPerformActions()">
                      <button mat-icon-button matSuffix
                              class="search-button document-search"
                              (click)="searchRamo()"
                              type="button"
                              [disabled]="!canPerformActions()"
                              matTooltip="Procurar Ramo">
                        <mat-icon>menu_vert</mat-icon>
                      </button>
                    </mat-form-field>
                  </div>
                </div>
              </div>

              <!-- Coluna da foto (col-sm-2) -->
              <div class="col-sm-2">
                <div class="photo-section">
                  <h5 class="photo-title">
                    <mat-icon>photo_camera</mat-icon>
                    Foto do Militar
                  </h5>

                  <div class="photo-container">
                    <!-- Preview da imagem -->
                    <div class="photo-preview" [class.has-photo]="militarPhoto">
                      <div *ngIf="!militarPhoto" class="no-photo-placeholder">
                        <mat-icon>person</mat-icon>
                        <span>Sem foto</span>
                      </div>

                      <img *ngIf="militarPhoto"
                           [src]="militarPhoto"
                           alt="Foto do militar"
                           class="militar-image">
                    </div>

                    <!-- Ações da foto -->
                    <div class="photo-actions">
                      <button mat-mini-fab
                              color="primary"
                              type="button"
                              (click)="openPhotoCapture()"
                              [disabled]="!canPerformActions()"
                              matTooltip="{{ militarPhoto ? 'Alterar Foto' : 'Adicionar Foto' }}">
                        <mat-icon>{{ militarPhoto ? 'edit' : 'add_a_photo' }}</mat-icon>
                      </button>

                      <button mat-mini-fab
                              color="warn"
                              type="button"
                              (click)="removePhoto()"
                              [disabled]="!canPerformActions() || !militarPhoto"
                              *ngIf="militarPhoto"
                              matTooltip="Remover Foto">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </mat-tab>

        <!-- Tab 2: Dados de Nascimento -->
        <mat-tab label="Local de Nascimento">
          <div class="tab-content">
            <div class="section-header">
              <h3 class="section-title">
                <mat-icon>place</mat-icon>
                Informações de Nascimento
              </h3>
            </div>

            <div class="form-grid form-grid-three-columns">
              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>País de Nascimento</mat-label>
                  <input matInput formControlName="nascPais" [disabled]="!canPerformActions()">
                  <button mat-icon-button matSuffix
                          class="search-button document-search"
                          (click)="searchPais('nascPais')"
                          type="button"
                          [disabled]="!canPerformActions()"
                          matTooltip="Procurar País">
                    <mat-icon>menu_vert</mat-icon>
                  </button>
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Província de Nascimento</mat-label>
                  <input matInput formControlName="nascProv"
                         [matAutocomplete]="autoProvinciaNasc"
                         [disabled]="!canPerformActions()">
                  <mat-autocomplete #autoProvinciaNasc="matAutocomplete"
                                    [displayWith]="displayFunction"
                                    (optionSelected)="onProvinciaSelected($event.option.value, 'nasc')">
                    <mat-option *ngFor="let option of filteredProvinciasNasc | async" [value]="option">
                      {{ option }}
                    </mat-option>
                  </mat-autocomplete>
                  <button mat-icon-button matSuffix
                          class="clear-button"
                          (click)="clearLocationSelection('nascProv', 'nasc')"
                          type="button"
                          [disabled]="!canPerformActions()"
                          matTooltip="Limpar Província">
                    <mat-icon>clear</mat-icon>
                  </button>
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Distrito de Nascimento</mat-label>
                  <input matInput formControlName="nascDist"
                         [matAutocomplete]="autoDistritoNasc"
                         [disabled]="!canPerformActions()">
                  <mat-autocomplete #autoDistritoNasc="matAutocomplete"
                                    [displayWith]="displayFunction"
                                    (optionSelected)="onDistritoSelected($event.option.value, 'nasc')">
                    <mat-option *ngFor="let option of filteredDistritosNasc | async" [value]="option">
                      {{ option }}
                    </mat-option>
                  </mat-autocomplete>
                  <button mat-icon-button matSuffix
                          class="clear-button"
                          (click)="clearLocationSelection('nascDist', 'nasc')"
                          type="button"
                          [disabled]="!canPerformActions()"
                          matTooltip="Limpar Distrito">
                    <mat-icon>clear</mat-icon>
                  </button>
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Posto Administrativo de Nascimento</mat-label>
                  <input matInput formControlName="nascPosto"
                         [matAutocomplete]="autoPostoNasc"
                         [disabled]="!canPerformActions()">
                  <mat-autocomplete #autoPostoNasc="matAutocomplete"
                                    [displayWith]="displayFunction"
                                    (optionSelected)="onPostoSelected($event.option.value, 'nasc')">
                    <mat-option *ngFor="let option of filteredPostosNasc | async" [value]="option">
                      {{ option }}
                    </mat-option>
                  </mat-autocomplete>
                  <button mat-icon-button matSuffix
                          class="clear-button"
                          (click)="clearLocationSelection('nascPosto', 'nasc')"
                          type="button"
                          [disabled]="!canPerformActions()"
                          matTooltip="Limpar Posto Administrativo">
                    <mat-icon>clear</mat-icon>
                  </button>
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Localidade de Nascimento</mat-label>
                  <input matInput formControlName="nascLocal"
                         [matAutocomplete]="autoLocalNasc"
                         [disabled]="!canPerformActions()">
                  <mat-autocomplete #autoLocalNasc="matAutocomplete"
                                    [displayWith]="displayFunction">
                    <mat-option *ngFor="let option of filteredLocalidadesNasc | async" [value]="option">
                      {{ option }}
                    </mat-option>
                  </mat-autocomplete>
                  <button mat-icon-button matSuffix
                          class="clear-button"
                          (click)="clearLocationSelection('nascLocal', 'nasc')"
                          type="button"
                          [disabled]="!canPerformActions()"
                          matTooltip="Limpar Localidade">
                    <mat-icon>clear</mat-icon>
                  </button>
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Povoação</mat-label>
                  <input matInput formControlName="nascPov" [disabled]="!canPerformActions()">
                </mat-form-field>
              </div>
            </div>
          </div>
        </mat-tab>

        <!-- Tab 3: Documentos -->
        <mat-tab label="Documentos">
          <div class="tab-content">
            <div class="section-header">
              <h3 class="section-title">
                <mat-icon>description</mat-icon>
                Documentos de Identificação
              </h3>
              <button mat-raised-button color="primary"
                      type="button"
                      (click)="adicionarDocumento()"
                      [disabled]="!canPerformActions()">
                <mat-icon>add</mat-icon>
                Adicionar Documento
              </button>
            </div>

            <div class="table-container">
              <table mat-table [dataSource]="docDataSource" class="data-table">
                <!-- Tipo de Documento Column -->
                <ng-container matColumnDef="tipoDocumento">
                  <th mat-header-cell *matHeaderCellDef>Tipo de Documento</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <div class="input-with-search">
                      <input class="table-input"
                             [formControl]="$any(docFormArray.at(i)).get('tipoDocumento')"
                             [disabled]="!canPerformActions()"
                             placeholder="Tipo de documento">
                      <button mat-icon-button
                              type="button"
                              (click)="selectedDocIndex = i; searchTipoDocumento(i)"
                              [disabled]="!canPerformActions()"
                              matTooltip="Procurar Tipo de Documento">
                        <mat-icon>menu_vert</mat-icon>
                      </button>
                    </div>
                  </td>
                </ng-container>

                <!-- Número do Documento Column -->
                <ng-container matColumnDef="numeroDoc">
                  <th mat-header-cell *matHeaderCellDef>Número</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <input class="table-input"
                           [formControl]="$any(docFormArray.at(i)).get('numeroDoc')"
                           [disabled]="!canPerformActions()"
                           placeholder="Número do documento">
                  </td>
                </ng-container>

                <!-- Local de Emissão Column -->
                <ng-container matColumnDef="localemissao">
                  <th mat-header-cell *matHeaderCellDef>Local de Emissão</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <div class="input-with-search">
                      <input class="table-input"
                             [formControl]="$any(docFormArray.at(i)).get('localemissao')"
                             [disabled]="!canPerformActions()"
                             placeholder="Local de emissão">
                      <button mat-icon-button
                              type="button"
                              (click)="selectedDocIndex = i; searchLocalEmissao(i)"
                              [disabled]="!canPerformActions()"
                              matTooltip="Procurar Local de Emissão">
                        <mat-icon>menu_vert</mat-icon>
                      </button>
                    </div>
                  </td>
                </ng-container>

                <!-- Data de Emissão Column -->
                <ng-container matColumnDef="dataemissao">
                  <th mat-header-cell *matHeaderCellDef>Data de Emissão</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <input class="table-input"
                           [formControl]="$any(docFormArray.at(i)).get('dataemissao')"
                           [disabled]="!canPerformActions()"
                           placeholder="Data de emissão"
                           type="date">
                  </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef>Ações</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <button mat-icon-button color="warn"
                            type="button"
                            (click)="removerDocumento(i)"
                            [disabled]="!canPerformActions()"
                            matTooltip="Remover">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="docColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: docColumns; let i = index"
                    [class.selected]="selectedDocIndex === i"
                    (click)="selectDocumento(i)"></tr>
              </table>
            </div>
          </div>
        </mat-tab>

        <!-- Tab 4: Dados de Residência -->
        <mat-tab label="Residência">
          <div class="tab-content">
            <div class="section-header">
              <h3 class="section-title">
                <mat-icon>home</mat-icon>
                Informações de Residência
              </h3>
            </div>

            <div class="form-grid">
              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Província de Residência</mat-label>
                  <input matInput formControlName="resProv"
                         [matAutocomplete]="autoProvinciaRes"
                         [disabled]="!canPerformActions()">
                  <mat-autocomplete #autoProvinciaRes="matAutocomplete"
                                    [displayWith]="displayFunction"
                                    (optionSelected)="onProvinciaSelected($event.option.value, 'res')">
                    <mat-option *ngFor="let option of filteredProvinciasRes | async" [value]="option">
                      {{ option }}
                    </mat-option>
                  </mat-autocomplete>
                  <button mat-icon-button matSuffix
                          class="clear-button"
                          (click)="clearLocationSelection('resProv', 'res')"
                          type="button"
                          [disabled]="!canPerformActions()"
                          matTooltip="Limpar Província">
                    <mat-icon>clear</mat-icon>
                  </button>
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Distrito de Residência</mat-label>
                  <input matInput formControlName="resDist"
                         [matAutocomplete]="autoDistritoRes"
                         [disabled]="!canPerformActions()">
                  <mat-autocomplete #autoDistritoRes="matAutocomplete"
                                    [displayWith]="displayFunction"
                                    (optionSelected)="onDistritoSelected($event.option.value, 'res')">
                    <mat-option *ngFor="let option of filteredDistritosRes | async" [value]="option">
                      {{ option }}
                    </mat-option>
                  </mat-autocomplete>
                  <button mat-icon-button matSuffix
                          class="clear-button"
                          (click)="clearLocationSelection('resDist', 'res')"
                          type="button"
                          [disabled]="!canPerformActions()"
                          matTooltip="Limpar Distrito">
                    <mat-icon>clear</mat-icon>
                  </button>
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Posto Administrativo</mat-label>
                  <input matInput formControlName="resPosto"
                         [matAutocomplete]="autoPostoRes"
                         [disabled]="!canPerformActions()">
                  <mat-autocomplete #autoPostoRes="matAutocomplete"
                                    [displayWith]="displayFunction"
                                    (optionSelected)="onPostoSelected($event.option.value, 'res')">
                    <mat-option *ngFor="let option of filteredPostosRes | async" [value]="option">
                      {{ option }}
                    </mat-option>
                  </mat-autocomplete>
                  <button mat-icon-button matSuffix
                          class="clear-button"
                          (click)="clearLocationSelection('resPosto', 'res')"
                          type="button"
                          [disabled]="!canPerformActions()"
                          matTooltip="Limpar Posto Administrativo">
                    <mat-icon>clear</mat-icon>
                  </button>
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Localidade</mat-label>
                  <input matInput formControlName="resLocalidade"
                         [matAutocomplete]="autoLocalRes"
                         [disabled]="!canPerformActions()">
                  <mat-autocomplete #autoLocalRes="matAutocomplete"
                                    [displayWith]="displayFunction">
                    <mat-option *ngFor="let option of filteredLocalidadesRes | async" [value]="option">
                      {{ option }}
                    </mat-option>
                  </mat-autocomplete>
                  <button mat-icon-button matSuffix
                          class="clear-button"
                          (click)="clearLocationSelection('resLocalidade', 'res')"
                          type="button"
                          [disabled]="!canPerformActions()"
                          matTooltip="Limpar Localidade">
                    <mat-icon>clear</mat-icon>
                  </button>
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Bairro</mat-label>
                  <input matInput formControlName="resBairro" [disabled]="!canPerformActions()">
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Quarteirão</mat-label>
                  <input matInput formControlName="resQuarteirao" [disabled]="!canPerformActions()">
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Avenida/Rua</mat-label>
                  <input matInput formControlName="resAvenida" [disabled]="!canPerformActions()">
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Número da Casa</mat-label>
                  <input matInput formControlName="numCasa" [disabled]="!canPerformActions()">
                </mat-form-field>
              </div>
            </div>
          </div>
        </mat-tab>

        <!-- Tab 5: Incorporação -->
        <mat-tab label="Incorporação">
          <div class="tab-content">
            <div class="section-header">
              <h3 class="section-title">
                <mat-icon>military_tech</mat-icon>
                Dados de Incorporação
              </h3>
            </div>

            <div class="form-grid form-grid-three-columns">
              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>País de Incorporação</mat-label>
                  <input matInput formControlName="incPais" [disabled]="!canPerformActions()">
                  <button mat-icon-button matSuffix
                          class="search-button document-search"
                          (click)="searchPais('incPais')"
                          type="button"
                          [disabled]="!canPerformActions()"
                          matTooltip="Procurar País">
                    <mat-icon>menu_vert</mat-icon>
                  </button>
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Província de Incorporação</mat-label>
                  <input matInput formControlName="incProv" 
                         [matAutocomplete]="incProvAutocomplete"
                         [disabled]="!canPerformActions()">
                  <mat-autocomplete #incProvAutocomplete="matAutocomplete" 
                                    [displayWith]="displayFunction"
                                    (optionSelected)="onProvinciaAutocompleteSelected($event, 'inc')">
                    <mat-option *ngFor="let option of filteredProvinciasInc | async" [value]="option">
                      {{ option }}
                    </mat-option>
                  </mat-autocomplete>
                  <button mat-icon-button matSuffix
                          class="clear-button"
                          (click)="clearLocationSelection('incProv', 'inc')"
                          type="button"
                          [disabled]="!canPerformActions()"
                          matTooltip="Limpar seleção">
                    <mat-icon>clear</mat-icon>
                  </button>
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Distrito de Incorporação</mat-label>
                  <input matInput formControlName="incDist" 
                         [matAutocomplete]="incDistAutocomplete"
                         [disabled]="!canPerformActions()">
                  <mat-autocomplete #incDistAutocomplete="matAutocomplete" 
                                    [displayWith]="displayFunction"
                                    (optionSelected)="onDistritoAutocompleteSelected($event, 'inc')">
                    <mat-option *ngFor="let option of filteredDistritosInc | async" [value]="option">
                      {{ option }}
                    </mat-option>
                  </mat-autocomplete>
                  <button mat-icon-button matSuffix
                          class="clear-button"
                          (click)="clearLocationSelection('incDist', 'inc')"
                          type="button"
                          [disabled]="!canPerformActions()"
                          matTooltip="Limpar seleção">
                    <mat-icon>clear</mat-icon>
                  </button>
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Posto Administrativo</mat-label>
                  <input matInput formControlName="incPosto" 
                         [matAutocomplete]="incPostoAutocomplete"
                         [disabled]="!canPerformActions()">
                  <mat-autocomplete #incPostoAutocomplete="matAutocomplete" 
                                    [displayWith]="displayFunction"
                                    (optionSelected)="onPostoAutocompleteSelected($event, 'inc')">
                    <mat-option *ngFor="let option of filteredPostosInc | async" [value]="option">
                      {{ option }}
                    </mat-option>
                  </mat-autocomplete>
                  <button mat-icon-button matSuffix
                          class="clear-button"
                          (click)="clearLocationSelection('incPosto', 'inc')"
                          type="button"
                          [disabled]="!canPerformActions()"
                          matTooltip="Limpar seleção">
                    <mat-icon>clear</mat-icon>
                  </button>
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Localidade</mat-label>
                  <input matInput formControlName="incLocal" 
                         [matAutocomplete]="incLocalAutocomplete"
                         [disabled]="!canPerformActions()">
                  <mat-autocomplete #incLocalAutocomplete="matAutocomplete" [displayWith]="displayFunction">
                    <mat-option *ngFor="let option of filteredLocalidadesInc | async" [value]="option">
                      {{ option }}
                    </mat-option>
                  </mat-autocomplete>
                  <button mat-icon-button matSuffix
                          class="clear-button"
                          (click)="clearLocationSelection('incLocal', 'inc')"
                          type="button"
                          [disabled]="!canPerformActions()"
                          matTooltip="Limpar seleção">
                    <mat-icon>clear</mat-icon>
                  </button>
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Data de Incorporação</mat-label>
                  <input matInput [matDatepicker]="incData" formControlName="incData" [disabled]="!canPerformActions()">
                  <mat-datepicker-toggle matSuffix [for]="incData" [disabled]="!canPerformActions()"></mat-datepicker-toggle>
                  <mat-datepicker #incData [disabled]="!canPerformActions()"></mat-datepicker>
                </mat-form-field>
              </div>
            </div>
          </div>
        </mat-tab>

        <!-- Tab 6: Treino Militar -->
        <mat-tab label="Treino">
          <div class="tab-content">
            <div class="section-header">
              <h3 class="section-title">
                <mat-icon>fitness_center</mat-icon>
                Informações de Treino
              </h3>
            </div>

            <div class="form-grid form-grid-three-columns">
              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Início do Treino</mat-label>
                  <input matInput [matDatepicker]="inicioTreino" formControlName="inicioTreino" [disabled]="!canPerformActions()">
                  <mat-datepicker-toggle matSuffix [for]="inicioTreino" [disabled]="!canPerformActions()"></mat-datepicker-toggle>
                  <mat-datepicker #inicioTreino [disabled]="!canPerformActions()"></mat-datepicker>
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Término do Treino</mat-label>
                  <input matInput [matDatepicker]="terminoTreino" formControlName="terminoTreino" [disabled]="!canPerformActions()">
                  <mat-datepicker-toggle matSuffix [for]="terminoTreino" [disabled]="!canPerformActions()"></mat-datepicker-toggle>
                  <mat-datepicker #terminoTreino [disabled]="!canPerformActions()"></mat-datepicker>
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Duração do Treino</mat-label>
                  <input matInput formControlName="duracaoTreino" [disabled]="!canPerformActions()">
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Centro de Treino</mat-label>
                  <input matInput formControlName="centroTreino" [disabled]="!canPerformActions()">
                  <button mat-icon-button matSuffix
                          class="search-button document-search"
                          (click)="searchCentroTreino()"
                          type="button"
                          [disabled]="!canPerformActions()"
                          matTooltip="Procurar Centro de Treino">
                    <mat-icon>menu_vert</mat-icon>
                  </button>
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Curso de Treino</mat-label>
                  <input matInput formControlName="cursoTreino" [disabled]="!canPerformActions()">
                  <button mat-icon-button matSuffix
                          class="search-button document-search"
                          (click)="searchCurso('cursoTreino')"
                          type="button"
                          [disabled]="!canPerformActions()"
                          matTooltip="Procurar Curso">
                    <mat-icon>menu_vert</mat-icon>
                  </button>
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Especialidade Adquirida</mat-label>
                  <input matInput formControlName="adquirEspecial" [disabled]="!canPerformActions()">
                  <button mat-icon-button matSuffix
                          class="search-button document-search"
                          (click)="searchEspecialidade('adquirEspecial')"
                          type="button"
                          [disabled]="!canPerformActions()"
                          matTooltip="Procurar Especialidade">
                    <mat-icon>menu_vert</mat-icon>
                  </button>
                </mat-form-field>
              </div>
            </div>
          </div>
        </mat-tab>

        <!-- Tab 7: Dados Médicos -->
        <mat-tab label="Dados Médicos">
          <div class="tab-content" formGroupName="milMed">
            <div class="section-header">
              <h3 class="section-title">
                <mat-icon>medical_services</mat-icon>
                Informações Médicas
              </h3>
            </div>

            <div class="form-grid">
              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Altura (cm)</mat-label>
                  <input matInput formControlName="altura" type="number" [disabled]="!canPerformActions()">
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Peso (kg)</mat-label>
                  <input matInput formControlName="peso" type="number" [disabled]="!canPerformActions()">
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Braço (cm)</mat-label>
                  <input matInput formControlName="braco" type="number" [disabled]="!canPerformActions()">
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Cabeça (cm)</mat-label>
                  <input matInput formControlName="cabeca" type="number" [disabled]="!canPerformActions()">
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Pescoço (cm)</mat-label>
                  <input matInput formControlName="pescoco" type="number" [disabled]="!canPerformActions()">
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Peito (cm)</mat-label>
                  <input matInput formControlName="peito" type="number" [disabled]="!canPerformActions()">
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Cintura (cm)</mat-label>
                  <input matInput formControlName="cintura" type="number" [disabled]="!canPerformActions()">
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Ancas (cm)</mat-label>
                  <input matInput formControlName="ancas" type="number" [disabled]="!canPerformActions()">
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Entrepernas (cm)</mat-label>
                  <input matInput formControlName="entrepernas" type="number" [disabled]="!canPerformActions()">
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Calçado (nº)</mat-label>
                  <input matInput formControlName="calcado" type="number" [disabled]="!canPerformActions()">
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Ombros (cm)</mat-label>
                  <input matInput formControlName="ombros" type="number" [disabled]="!canPerformActions()">
                </mat-form-field>
              </div>
            </div>
          </div>
        </mat-tab>

        <!-- Tab 8: Salário -->
        <mat-tab label="Dados Salariais">
          <div class="tab-content" formGroupName="milSalario">
            <div class="section-header">
              <h3 class="section-title">
                <mat-icon>payments</mat-icon>
                Informações Salariais
              </h3>
            </div>

            <!-- Checkboxes section - mantém layout original -->
            <div class="form-grid">
              <div class="form-group">
                <mat-checkbox formControlName="uCerimonial" [disabled]="!canPerformActions()">
                  Uniforme Cerimonial
                </mat-checkbox>
              </div>

              <div class="form-group">
                <mat-checkbox formControlName="saudeMilitar" [disabled]="!canPerformActions()">
                  Saúde Militar
                </mat-checkbox>
              </div>

              <div class="form-group">
                <mat-checkbox formControlName="recebePatente" [disabled]="!canPerformActions()">
                  Recebe por Patente
                </mat-checkbox>
              </div>

              <div class="form-group">
                <mat-checkbox formControlName="recebeSqtc" [disabled]="!canPerformActions()">
                  Recebe SQTC
                </mat-checkbox>
              </div>
            </div>

            <!-- Campos de input - layout de 3 colunas -->
            <div class="form-grid form-grid-three-columns">
              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Escalão</mat-label>
                  <input matInput formControlName="escalao" [disabled]="!canPerformActions()">
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>SQTC</mat-label>
                  <input matInput formControlName="sQTC" [disabled]="!canPerformActions()">
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Nível Salarial</mat-label>
                  <input matInput formControlName="nivelSalarial" [disabled]="!canPerformActions()">
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Nome do Banco</mat-label>
                  <input matInput formControlName="nomeBanco" [disabled]="!canPerformActions()">
                  <button mat-icon-button matSuffix
                          class="search-button document-search"
                          (click)="searchBanco()"
                          type="button"
                          [disabled]="!canPerformActions()"
                          matTooltip="Procurar Banco">
                    <mat-icon>menu_vert</mat-icon>
                  </button>
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>Número da Conta</mat-label>
                  <input matInput formControlName="nrConta" [disabled]="!canPerformActions()">
                </mat-form-field>
              </div>

              <div class="form-group">
                <mat-form-field appearance="outline">
                  <mat-label>NIB</mat-label>
                  <input matInput formControlName="nib" [disabled]="!canPerformActions()">
                </mat-form-field>
              </div>

              <div class="form-group form-group-full">
                <mat-form-field appearance="outline">
                  <mat-label>Observações</mat-label>
                  <textarea matInput formControlName="obs" rows="3" [disabled]="!canPerformActions()"></textarea>
                </mat-form-field>
              </div>
            </div>
          </div>
        </mat-tab>

        <!-- Tab 9: Agregados Familiares -->
        <mat-tab label="Agregados Familiares">
          <div class="tab-content">
            <div class="section-header">
              <h3 class="section-title">
                <mat-icon>family_restroom</mat-icon>
                Agregados Familiares
              </h3>
              <button mat-raised-button color="primary"
                      type="button"
                      (click)="adicionarAgregado()"
                      [disabled]="!canPerformActions()">
                <mat-icon>add</mat-icon>
                Adicionar Agregado
              </button>
            </div>

            <div class="table-container">
              <table mat-table [dataSource]="agreDataSource" class="data-table">
                <!-- Nome Column -->
                <ng-container matColumnDef="nome">
                  <th mat-header-cell *matHeaderCellDef>Nome</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <input class="table-input"
                           [formControl]="$any(agreFormArray.at(i)).get('nome')"
                           [disabled]="!canPerformActions()"
                           placeholder="Nome completo">
                  </td>
                </ng-container>

                <!-- Grau Column -->
                <ng-container matColumnDef="grau">
                  <th mat-header-cell *matHeaderCellDef>Grau de Parentesco</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <div class="input-with-search">
                      <input class="table-input"
                             [formControl]="$any(agreFormArray.at(i)).get('grau')"
                             [disabled]="!canPerformActions()"
                             placeholder="Grau de parentesco">
                      <button mat-icon-button
                              type="button"
                              (click)="selectedAgreIndex = i; searchGrauParentesco(i)"
                              [disabled]="!canPerformActions()"
                              matTooltip="Procurar Grau de Parentesco">
                        <mat-icon>menu_vert</mat-icon>
                      </button>
                    </div>
                  </td>
                </ng-container>

                <!-- Data Nascimento Column -->
                <ng-container matColumnDef="nascData">
                  <th mat-header-cell *matHeaderCellDef>Data de Nascimento</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <input class="table-input"
                           [formControl]="$any(agreFormArray.at(i)).get('nascData')"
                           [disabled]="!canPerformActions()"
                           placeholder="Data de nascimento"
                           type="date">
                  </td>
                </ng-container>

                <!-- Telefone Column -->
                <ng-container matColumnDef="telefone">
                  <th mat-header-cell *matHeaderCellDef>Telefone</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <input class="table-input"
                           [formControl]="$any(agreFormArray.at(i)).get('telefone')"
                           [disabled]="!canPerformActions()"
                           placeholder="Telefone"
                           type="tel">
                  </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef>Ações</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <button mat-icon-button color="warn"
                            type="button"
                            (click)="removerAgregado(i)"
                            [disabled]="!canPerformActions()"
                            matTooltip="Remover">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="agreColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: agreColumns; let i = index"
                    [class.selected]="selectedAgreIndex === i"
                    (click)="selectAgregado(i)"></tr>
              </table>
            </div>
          </div>
        </mat-tab>

        <!-- Tab 9: Condecorações -->
        <mat-tab label="Condecorações">
          <div class="tab-content">
            <div class="section-header">
              <h3 class="section-title">
                <mat-icon>military_tech</mat-icon>
                Condecorações e Galardões
              </h3>
              <button mat-raised-button color="primary"
                      type="button"
                      (click)="adicionarCondecoracoes()"
                      [disabled]="!canPerformActions()">
                <mat-icon>add</mat-icon>
                Adicionar Condecoração
              </button>
            </div>

            <div class="table-container">
              <table mat-table [dataSource]="condeDataSource" class="data-table">
                <!-- Galardão Column -->
                <ng-container matColumnDef="galardoa">
                  <th mat-header-cell *matHeaderCellDef>Galardão</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <input class="table-input"
                           [formControl]="$any(condeFormArray.at(i)).get('galardoa')"
                           [disabled]="!canPerformActions()"
                           placeholder="Galardão">
                  </td>
                </ng-container>

                <!-- Espécie Column -->
                <ng-container matColumnDef="especie">
                  <th mat-header-cell *matHeaderCellDef>Espécie</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <input class="table-input"
                           [formControl]="$any(condeFormArray.at(i)).get('especie')"
                           [disabled]="!canPerformActions()"
                           placeholder="Espécie">
                  </td>
                </ng-container>

                <!-- Grau da Medalha Column -->
                <ng-container matColumnDef="grauMedalha">
                  <th mat-header-cell *matHeaderCellDef>Grau da Medalha</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <input class="table-input"
                           [formControl]="$any(condeFormArray.at(i)).get('grauMedalha')"
                           [disabled]="!canPerformActions()"
                           placeholder="Grau da medalha">
                  </td>
                </ng-container>

                <!-- Data de Galardoação Column -->
                <ng-container matColumnDef="dataGalardoacao">
                  <th mat-header-cell *matHeaderCellDef>Data de Galardoação</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <input class="table-input"
                           [formControl]="$any(condeFormArray.at(i)).get('dataGalardoacao')"
                           [disabled]="!canPerformActions()"
                           placeholder="Data de galardoação"
                           type="date">
                  </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef>Ações</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <button mat-icon-button color="warn"
                            type="button"
                            (click)="removerCondecoracoes(i)"
                            [disabled]="!canPerformActions()"
                            matTooltip="Remover">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="condeColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: condeColumns; let i = index"
                    [class.selected]="selectedCondeIndex === i"
                    (click)="selectCondecoracoes(i)"></tr>
              </table>
            </div>
          </div>
        </mat-tab>

        <!-- Tab 10: Emails -->
        <mat-tab label="Emails">
          <div class="tab-content">
            <div class="section-header">
              <h3 class="section-title">
                <mat-icon>email</mat-icon>
                Endereços de Email
              </h3>
              <button mat-raised-button color="primary"
                      type="button"
                      (click)="adicionarEmail()"
                      [disabled]="!canPerformActions()">
                <mat-icon>add</mat-icon>
                Adicionar Email
              </button>
            </div>

            <div class="table-container">
              <table mat-table [dataSource]="emailDataSource" class="data-table">
                <!-- Email Column -->
                <ng-container matColumnDef="email">
                  <th mat-header-cell *matHeaderCellDef>Email</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <mat-form-field appearance="outline" class="table-field">
                      <input matInput [formControl]="$any(emailFormArray.at(i)).get('email')"
                             type="email" [disabled]="!canPerformActions()">
                    </mat-form-field>
                  </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef>Ações</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <button mat-icon-button color="warn"
                            type="button"
                            (click)="removerEmail(i)"
                            [disabled]="!canPerformActions()"
                            matTooltip="Remover">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="emailColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: emailColumns; let i = index"
                    [class.selected]="selectedEmailIndex === i"
                    (click)="selectEmail(i)"></tr>
              </table>
            </div>
          </div>
        </mat-tab>

        <!-- Tab 11: Telefones -->
        <mat-tab label="Telefones">
          <div class="tab-content">
            <div class="section-header">
              <h3 class="section-title">
                <mat-icon>phone</mat-icon>
                Números de Telefone
              </h3>
              <button mat-raised-button color="primary"
                      type="button"
                      (click)="adicionarTelefone()"
                      [disabled]="!canPerformActions()">
                <mat-icon>add</mat-icon>
                Adicionar Telefone
              </button>
            </div>

            <div class="table-container">
              <table mat-table [dataSource]="telefoneDataSource" class="data-table">
                <!-- Número Column -->
                <ng-container matColumnDef="numero">
                  <th mat-header-cell *matHeaderCellDef>Número</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <mat-form-field appearance="outline" class="table-field">
                      <input matInput [formControl]="$any(telefoneFormArray.at(i)).get('numero')" [disabled]="!canPerformActions()">
                    </mat-form-field>
                  </td>
                </ng-container>

                <!-- Tipo Column -->
                <ng-container matColumnDef="tipo">
                  <th mat-header-cell *matHeaderCellDef>Tipo</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <mat-form-field appearance="outline" class="table-field">
                      <input matInput
                             [formControl]="$any(telefoneFormArray.at(i)).get('tipo')"
                             [disabled]="!canPerformActions()"
                             [matAutocomplete]="autoTipoTelefone"
                             placeholder="Digite para procurar...">
                      <mat-autocomplete #autoTipoTelefone="matAutocomplete">
                        <mat-option *ngFor="let tipo of getFilteredTipoTelefone($any(telefoneFormArray.at(i)).get('tipo')) | async" [value]="tipo">
                          {{tipo}}
                        </mat-option>
                      </mat-autocomplete>
                      <button mat-icon-button matSuffix
                              type="button"
                              (click)="clearArrayControlSelection('telefones', i, 'tipo')"
                              [disabled]="!canPerformActions() || !$any(telefoneFormArray.at(i)).get('tipo')?.value"
                              matTooltip="Limpar seleção">
                        <mat-icon>clear</mat-icon>
                      </button>
                    </mat-form-field>
                  </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef>Ações</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <button mat-icon-button color="warn"
                            type="button"
                            (click)="removerTelefone(i)"
                            [disabled]="!canPerformActions()"
                            matTooltip="Remover">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="telefoneColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: telefoneColumns; let i = index"
                    [class.selected]="selectedTelefoneIndex === i"
                    (click)="selectTelefone(i)"></tr>
              </table>
            </div>
          </div>
        </mat-tab>

        <!-- Tab 12: Formação -->
        <mat-tab label="Formação">
          <div class="tab-content">
            <div class="section-header">
              <h3 class="section-title">
                <mat-icon>school</mat-icon>
                Formação Acadêmica
              </h3>
              <button mat-raised-button color="primary"
                      type="button"
                      (click)="adicionarFormacao()"
                      [disabled]="!canPerformActions()">
                <mat-icon>add</mat-icon>
                Adicionar Formação
              </button>
            </div>

            <div class="table-container">
              <table mat-table [dataSource]="forDataSource" class="data-table">
                <!-- Curso Column -->
                <ng-container matColumnDef="curso">
                  <th mat-header-cell *matHeaderCellDef>Curso</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <mat-form-field appearance="outline" class="table-field">
                      <input matInput [formControl]="$any(forFormArray.at(i)).get('curso')" [disabled]="!canPerformActions()">
                    </mat-form-field>
                  </td>
                </ng-container>

                <!-- Instituição Column -->
                <ng-container matColumnDef="instituicao">
                  <th mat-header-cell *matHeaderCellDef>Instituição</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <mat-form-field appearance="outline" class="table-field">
                      <input matInput [formControl]="$any(forFormArray.at(i)).get('instituicao')" [disabled]="!canPerformActions()">
                    </mat-form-field>
                  </td>
                </ng-container>

                <!-- Data Início Column -->
                <ng-container matColumnDef="dataInicio">
                  <th mat-header-cell *matHeaderCellDef>Data de Início</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <mat-form-field appearance="outline" class="table-field">
                      <input matInput [formControl]="$any(forFormArray.at(i)).get('dataInicio')" [disabled]="!canPerformActions()">
                    </mat-form-field>
                  </td>
                </ng-container>

                <!-- Data Término Column -->
                <ng-container matColumnDef="dataTermino">
                  <th mat-header-cell *matHeaderCellDef>Data de Término</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <mat-form-field appearance="outline" class="table-field">
                      <input matInput [formControl]="$any(forFormArray.at(i)).get('dataTermino')" [disabled]="!canPerformActions()">
                    </mat-form-field>
                  </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef>Ações</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <button mat-icon-button color="warn"
                            type="button"
                            (click)="removerFormacao(i)"
                            [disabled]="!canPerformActions()"
                            matTooltip="Remover">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="forColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: forColumns; let i = index"
                    [class.selected]="selectedForIndex === i"
                    (click)="selectFormacao(i)"></tr>
              </table>
            </div>
          </div>
        </mat-tab>

        <!-- Tab 13: Línguas -->
        <mat-tab label="Línguas">
          <div class="tab-content">
            <div class="section-header">
              <h3 class="section-title">
                <mat-icon>translate</mat-icon>
                Conhecimento de Línguas
              </h3>
              <button mat-raised-button color="primary"
                      type="button"
                      (click)="adicionarLingua()"
                      [disabled]="!canPerformActions()">
                <mat-icon>add</mat-icon>
                Adicionar Língua
              </button>
            </div>

            <div class="table-container">
              <table mat-table [dataSource]="linguaDataSource" class="data-table">
                <!-- Língua Column -->
                <ng-container matColumnDef="lingua">
                  <th mat-header-cell *matHeaderCellDef>Língua</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <mat-form-field appearance="outline" class="table-field">
                      <input matInput [formControl]="$any(linguaFormArray.at(i)).get('lingua')" [disabled]="!canPerformActions()">
                    </mat-form-field>
                  </td>
                </ng-container>

                <!-- Fala Column -->
                <ng-container matColumnDef="fala">
                  <th mat-header-cell *matHeaderCellDef>Fala</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <mat-form-field appearance="outline" class="table-field">
                      <input matInput
                             [formControl]="$any(linguaFormArray.at(i)).get('fala')"
                             [disabled]="!canPerformActions()"
                             [matAutocomplete]="autoFala"
                             placeholder="Digite para procurar...">
                      <mat-autocomplete #autoFala="matAutocomplete">
                        <mat-option *ngFor="let nivel of getFilteredNivelLingua($any(linguaFormArray.at(i)).get('fala')) | async" [value]="nivel">
                          {{nivel}}
                        </mat-option>
                      </mat-autocomplete>
                      <button mat-icon-button matSuffix
                              type="button"
                              (click)="clearArrayControlSelection('linguas', i, 'fala')"
                              [disabled]="!canPerformActions() || !$any(linguaFormArray.at(i)).get('fala')?.value"
                              matTooltip="Limpar seleção">
                        <mat-icon>clear</mat-icon>
                      </button>
                    </mat-form-field>
                  </td>
                </ng-container>

                <!-- Leitura Column -->
                <ng-container matColumnDef="leitura">
                  <th mat-header-cell *matHeaderCellDef>Leitura</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <mat-form-field appearance="outline" class="table-field">
                      <input matInput
                             [formControl]="$any(linguaFormArray.at(i)).get('leitura')"
                             [disabled]="!canPerformActions()"
                             [matAutocomplete]="autoLeitura"
                             placeholder="Digite para procurar...">
                      <mat-autocomplete #autoLeitura="matAutocomplete">
                        <mat-option *ngFor="let nivel of getFilteredNivelLingua($any(linguaFormArray.at(i)).get('leitura')) | async" [value]="nivel">
                          {{nivel}}
                        </mat-option>
                      </mat-autocomplete>
                      <button mat-icon-button matSuffix
                              type="button"
                              (click)="clearArrayControlSelection('linguas', i, 'leitura')"
                              [disabled]="!canPerformActions() || !$any(linguaFormArray.at(i)).get('leitura')?.value"
                              matTooltip="Limpar seleção">
                        <mat-icon>clear</mat-icon>
                      </button>
                    </mat-form-field>
                  </td>
                </ng-container>

                <!-- Escrita Column -->
                <ng-container matColumnDef="escrita">
                  <th mat-header-cell *matHeaderCellDef>Escrita</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <mat-form-field appearance="outline" class="table-field">
                      <input matInput
                             [formControl]="$any(linguaFormArray.at(i)).get('escrita')"
                             [disabled]="!canPerformActions()"
                             [matAutocomplete]="autoEscrita"
                             placeholder="Digite para procurar...">
                      <mat-autocomplete #autoEscrita="matAutocomplete">
                        <mat-option *ngFor="let nivel of getFilteredNivelLingua($any(linguaFormArray.at(i)).get('escrita')) | async" [value]="nivel">
                          {{nivel}}
                        </mat-option>
                      </mat-autocomplete>
                      <button mat-icon-button matSuffix
                              type="button"
                              (click)="clearArrayControlSelection('linguas', i, 'escrita')"
                              [disabled]="!canPerformActions() || !$any(linguaFormArray.at(i)).get('escrita')?.value"
                              matTooltip="Limpar seleção">
                        <mat-icon>clear</mat-icon>
                      </button>
                    </mat-form-field>
                  </td>
                </ng-container>

                <!-- Materna Column -->
                <ng-container matColumnDef="materna">
                  <th mat-header-cell *matHeaderCellDef>Materna</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <mat-checkbox [formControl]="$any(linguaFormArray.at(i)).get('materna')" [disabled]="!canPerformActions()">
                    </mat-checkbox>
                  </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef>Ações</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <button mat-icon-button color="warn"
                            type="button"
                            (click)="removerLingua(i)"
                            [disabled]="!canPerformActions()"
                            matTooltip="Remover">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="linguaColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: linguaColumns; let i = index"
                    [class.selected]="selectedLinguaIndex === i"
                    (click)="selectLingua(i)"></tr>
              </table>
            </div>
          </div>
        </mat-tab>

        <!-- Tab 14: Situações -->
        <mat-tab label="Situações">
          <div class="tab-content">
            <div class="section-header">
              <h3 class="section-title">
                <mat-icon>assignment</mat-icon>
                Situações Militares
              </h3>
              <button mat-raised-button color="primary"
                      type="button"
                      (click)="adicionarSituacao()"
                      [disabled]="!canPerformActions()">
                <mat-icon>add</mat-icon>
                Adicionar Situação
              </button>
            </div>

            <div class="table-container">
              <table mat-table [dataSource]="sitDataSource" class="data-table">
                <!-- Situação Column -->
                <ng-container matColumnDef="situacao">
                  <th mat-header-cell *matHeaderCellDef>Situação</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <mat-form-field appearance="outline" class="table-field">
                      <input matInput [formControl]="$any(sitFormArray.at(i)).get('situacao')" [disabled]="!canPerformActions()">
                    </mat-form-field>
                  </td>
                </ng-container>

                <!-- Data OS Column -->
                <ng-container matColumnDef="dataOS">
                  <th mat-header-cell *matHeaderCellDef>Data da OS</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <mat-form-field appearance="outline" class="table-field">
                      <input matInput [formControl]="$any(sitFormArray.at(i)).get('dataOS')" [disabled]="!canPerformActions()">
                    </mat-form-field>
                  </td>
                </ng-container>

                <!-- Número OS Column -->
                <ng-container matColumnDef="numOS">
                  <th mat-header-cell *matHeaderCellDef>Nº OS</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <mat-form-field appearance="outline" class="table-field">
                      <input matInput [formControl]="$any(sitFormArray.at(i)).get('numOS')" [disabled]="!canPerformActions()">
                    </mat-form-field>
                  </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef>Ações</th>
                  <td mat-cell *matCellDef="let element; let i = index">
                    <button mat-icon-button color="warn"
                            type="button"
                            (click)="removerSituacao(i)"
                            [disabled]="!canPerformActions()"
                            matTooltip="Remover">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="sitColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: sitColumns; let i = index"
                    [class.selected]="selectedSitIndex === i"
                    (click)="selectSituacao(i)"></tr>
              </table>
            </div>
          </div>
        </mat-tab>

      </mat-tab-group>
    </div>
  </form>
</div>
